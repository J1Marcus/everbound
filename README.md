# Supabase Self-Hosted Installation & Usage Guide

A production-ready, reusable template for deploying self-hosted Supabase instances using Docker. This template supports running multiple isolated instances on the same server with comprehensive tooling for deployment, backup, and management.

## Table of Contents

- [Features](#features)
- [Prerequisites](#prerequisites)
- [Quick Start](#quick-start)
- [Development Installation](#development-installation)
- [Production Installation](#production-installation)
- [Usage](#usage)
- [Configuration](#configuration)
- [Management Scripts](#management-scripts)
- [Multi-Instance Support](#multi-instance-support)
- [Troubleshooting](#troubleshooting)
- [Documentation](#documentation)

## Features

- üê≥ **Docker-based deployment** - All services containerized for easy deployment
- üîí **Security-first** - Secrets management, SSL/TLS, row-level security
- üì¶ **Complete stack** - PostgreSQL, Auth, Storage, Realtime, Edge Functions, Studio
- üîÑ **Multi-instance support** - Run multiple isolated instances on the same server
- üõ†Ô∏è **Management scripts** - Automated backup, restore, deployment, and health checks
- üìö **Comprehensive docs** - Setup, deployment, API reference, and troubleshooting guides
- üöÄ **Production-ready** - Caddy reverse proxy with automatic HTTPS

## Prerequisites

### System Requirements

- **Operating System**: Linux (Ubuntu 20.04+ recommended), macOS, or Windows with WSL2
- **Docker**: 20.10 or higher
- **Docker Compose**: 2.0 or higher
- **RAM**: 4GB minimum (8GB recommended for production)
- **Disk Space**: 20GB minimum (50GB+ recommended for production)
- **CPU**: 2 cores minimum (4+ cores recommended for production)

### Software Dependencies

```bash
# Check Docker version
docker --version  # Should be 20.10+

# Check Docker Compose version
docker compose version  # Should be 2.0+

# Required for secret generation
openssl version
```

### Production Additional Requirements

- Domain name with DNS access
- SSL certificate (or use Caddy's automatic HTTPS)
- Firewall configuration access
- SMTP server for email authentication (optional)

## Quick Start

Get up and running in 5 minutes:

```bash
# 1. Clone the repository
git clone <repository-url>
cd supabase-template

# 2. Copy environment template
cp docker/.env.example docker/.env

# 3. Generate secure secrets
./scripts/generate-secrets.sh

# 4. Start services
cd docker
docker compose up -d

# 5. Access Supabase Studio
open http://localhost:3000
```

**Default Credentials:**
- Studio: `http://localhost:3000`
- API Gateway: `http://localhost:8000`
- Username: `supabase`
- Password: Check `DASHBOARD_PASSWORD` in [`docker/.env`](docker/.env)

## Development Installation

### Step 1: Clone and Setup

```bash
# Clone the repository
git clone <repository-url>
cd supabase-template

# Verify directory structure
ls -la
```

### Step 2: Configure Environment

```bash
# Copy the environment template
cp docker/.env.example docker/.env

# Generate secure secrets (REQUIRED)
./scripts/generate-secrets.sh

# Optional: Edit configuration
nano docker/.env
```

**Key Environment Variables to Review:**

```bash
# Database
POSTGRES_PASSWORD=<auto-generated>

# JWT Authentication
JWT_SECRET=<auto-generated>
ANON_KEY=<auto-generated>
SERVICE_ROLE_KEY=<auto-generated>

# URLs (for local development)
SITE_URL=http://localhost:3000
API_EXTERNAL_URL=http://localhost:8000
SUPABASE_PUBLIC_URL=http://localhost:8000

# Email (optional for development)
SMTP_HOST=supabase-mail
SMTP_PORT=2500
ENABLE_EMAIL_AUTOCONFIRM=true
```

### Step 3: Start Services

```bash
# Navigate to docker directory
cd docker

# Start all services
docker compose up -d

# View logs
docker compose logs -f

# Check service health
docker compose ps
```

### Step 4: Verify Installation

```bash
# Run health check
cd ..
./scripts/health-check.sh

# Access services
# Studio: http://localhost:3000
# API: http://localhost:8000
# Analytics: http://localhost:4000
```

### Step 5: Initial Configuration

1. **Access Studio**: Open `http://localhost:3000`
2. **Login**: Use credentials from [`docker/.env`](docker/.env)
3. **Create Database Tables**: Use the SQL editor
4. **Configure Auth**: Set up authentication providers
5. **Test API**: Make a test request to `http://localhost:8000`

### Development Commands

```bash
# Start services
docker compose up -d

# Stop services
docker compose down

# View logs
docker compose logs -f [service-name]

# Restart a specific service
docker compose restart [service-name]

# Rebuild and restart
docker compose up -d --build

# Clean everything (WARNING: deletes data)
docker compose down -v --remove-orphans
```

## Production Installation

### Step 1: Server Preparation

```bash
# Update system
sudo apt update && sudo apt upgrade -y

# Install Docker
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh

# Install Docker Compose
sudo apt install docker-compose-plugin

# Verify installation
docker --version
docker compose version
```

### Step 2: Clone and Configure

```bash
# Clone repository
git clone <repository-url>
cd supabase-template

# Copy environment template
cp docker/.env.example docker/.env

# Generate production secrets
./scripts/generate-secrets.sh --production
```

### Step 3: Configure Production Environment

Edit [`docker/.env`](docker/.env) with production values:

```bash
# Project identification
PROJECT_NAME=production_supabase
PORT_OFFSET=0

# Database (use strong passwords)
POSTGRES_PASSWORD=<generated-secure-password>

# JWT (auto-generated)
JWT_SECRET=<generated-secret>
ANON_KEY=<generated-token>
SERVICE_ROLE_KEY=<generated-token>

# Production URLs
SITE_URL=https://yourdomain.com
API_EXTERNAL_URL=https://api.yourdomain.com
SUPABASE_PUBLIC_URL=https://api.yourdomain.com

# Email configuration (required for production)
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_USER=apikey
SMTP_PASS=<your-sendgrid-api-key>
SMTP_ADMIN_EMAIL=admin@yourdomain.com
ENABLE_EMAIL_AUTOCONFIRM=false

# Security
DISABLE_SIGNUP=false  # Set to true to disable public signups
```

### Step 4: Configure DNS

Point your domains to the server IP:

```
A    api.yourdomain.com      -> YOUR_SERVER_IP
A    studio.yourdomain.com   -> YOUR_SERVER_IP
```

### Step 5: Configure Reverse Proxy (Caddy)

Edit [`caddy/Caddyfile.prod`](caddy/Caddyfile.prod):

```caddyfile
# API Gateway
api.yourdomain.com {
    reverse_proxy localhost:8000
}

# Studio
studio.yourdomain.com {
    reverse_proxy localhost:3000
}
```

### Step 6: Configure Firewall

```bash
# Allow SSH
sudo ufw allow 22/tcp

# Allow HTTP/HTTPS
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp

# Enable firewall
sudo ufw enable

# Check status
sudo ufw status
```

### Step 7: Deploy

```bash
# Deploy with all safety checks
./scripts/deploy.sh --production

# Or use the comprehensive deployment
./scripts/deploy.sh --production --build --prune
```

### Step 8: Verify Production Deployment

```bash
# Check service health
./scripts/health-check.sh

# View logs
cd docker
docker compose logs -f

# Test API endpoint
curl https://api.yourdomain.com/rest/v1/

# Access Studio
open https://studio.yourdomain.com
```

### Step 9: Setup Automated Backups

```bash
# Create backup script
sudo crontab -e

# Add daily backup at 2 AM
0 2 * * * /path/to/supabase-template/scripts/backup.sh

# Test backup manually
./scripts/backup.sh
```

## Usage

### Accessing Services

**Development:**
- Studio: `http://localhost:3000`
- API Gateway: `http://localhost:8000`
- Database: `localhost:5432`
- Analytics: `http://localhost:4000`

**Production:**
- Studio: `https://studio.yourdomain.com`
- API Gateway: `https://api.yourdomain.com`
- Database: Internal only (not exposed)

### Making API Requests

```bash
# Get anonymous key from .env
source docker/.env

# List tables (requires authentication)
curl -X GET 'http://localhost:8000/rest/v1/' \
  -H "apikey: $ANON_KEY" \
  -H "Authorization: Bearer $ANON_KEY"

# Insert data
curl -X POST 'http://localhost:8000/rest/v1/your_table' \
  -H "apikey: $ANON_KEY" \
  -H "Authorization: Bearer $ANON_KEY" \
  -H "Content-Type: application/json" \
  -d '{"column": "value"}'

# Query data
curl -X GET 'http://localhost:8000/rest/v1/your_table?select=*' \
  -H "apikey: $ANON_KEY" \
  -H "Authorization: Bearer $ANON_KEY"
```

### Using Edge Functions

```bash
# Create a new function
mkdir -p docker/volumes/functions/my-function
cat > docker/volumes/functions/my-function/index.ts << 'EOF'
import { serve } from "https://deno.land/std@0.168.0/http/server.ts"

serve(async (req) => {
  const { name } = await req.json()
  const data = {
    message: `Hello ${name}!`,
  }
  return new Response(
    JSON.stringify(data),
    { headers: { "Content-Type": "application/json" } },
  )
})
EOF

# Restart functions service
cd docker
docker compose restart functions

# Invoke function
curl -X POST 'http://localhost:8000/functions/v1/my-function' \
  -H "Authorization: Bearer $ANON_KEY" \
  -H "Content-Type: application/json" \
  -d '{"name": "World"}'
```

### Database Management

```bash
# Connect to database
docker exec -it supabase-db psql -U postgres

# Run SQL file
docker exec -i supabase-db psql -U postgres < your-script.sql

# Create backup
./scripts/backup.sh

# Restore from backup
./scripts/restore.sh --backup /path/to/backup
```

## Configuration

### Environment Variables

See [`docs/ENVIRONMENT_VARIABLES.md`](docs/ENVIRONMENT_VARIABLES.md) for complete reference.

**Critical Variables:**

| Variable | Description | Required |
|----------|-------------|----------|
| `PROJECT_NAME` | Unique instance identifier | Yes |
| `POSTGRES_PASSWORD` | Database password | Yes |
| `JWT_SECRET` | JWT signing secret | Yes |
| `ANON_KEY` | Anonymous access token | Yes |
| `SERVICE_ROLE_KEY` | Service role token | Yes |
| `API_EXTERNAL_URL` | External API URL | Yes |
| `SITE_URL` | Frontend URL | Yes |

### Port Configuration

Default ports (can be customized with `PORT_OFFSET`):

- Studio: `3000`
- Kong (API Gateway): `8000`
- Kong HTTPS: `8443`
- PostgreSQL: `5432`
- Analytics: `4000`

### Multi-Instance Configuration

To run multiple instances, set unique values:

```bash
# Instance 1
PROJECT_NAME=customer_a_supabase
PORT_OFFSET=0

# Instance 2
PROJECT_NAME=customer_b_supabase
PORT_OFFSET=100

# Instance 3
PROJECT_NAME=dev_supabase
PORT_OFFSET=200
```

## Management Scripts

All scripts are located in [`scripts/`](scripts/) directory:

### Deployment

```bash
# Local deployment
./scripts/deploy.sh --local

# Production deployment
./scripts/deploy.sh --production

# Full rebuild and cleanup
./scripts/deploy.sh --build --prune

# Quick restart
./scripts/deploy.sh --restart
```

### Backup & Restore

```bash
# Create backup
./scripts/backup.sh

# Restore from backup
./scripts/restore.sh --backup /path/to/backup

# List backups
ls -lh backups/
```

### Health Checks

```bash
# Check all services
./scripts/health-check.sh

# Check specific service
docker compose ps [service-name]

# View service logs
docker compose logs -f [service-name]
```

### Secret Management

```bash
# Generate all secrets
./scripts/generate-secrets.sh

# Regenerate JWT tokens only
./scripts/generate-secrets.sh --jwt-only

# Show current secrets (masked)
./scripts/generate-secrets.sh --show

# Production mode with validation
./scripts/generate-secrets.sh --production
```

### Instance Management

```bash
# List all instances
./scripts/list-instances.sh

# Validate instance configuration
./scripts/validate-instance.sh

# Switch between instances
./scripts/switch-instance.sh [instance-name]
```

## Multi-Instance Support

Run multiple isolated Supabase instances on the same server:

### Configuration

Each instance needs unique values in [`docker/.env`](docker/.env):

```bash
# Instance 1: Production
PROJECT_NAME=prod_supabase
PORT_OFFSET=0
STUDIO_PORT=3000
KONG_HTTP_PORT=8000

# Instance 2: Staging
PROJECT_NAME=staging_supabase
PORT_OFFSET=100
STUDIO_PORT=3100
KONG_HTTP_PORT=8100

# Instance 3: Development
PROJECT_NAME=dev_supabase
PORT_OFFSET=200
STUDIO_PORT=3200
KONG_HTTP_PORT=8200
```

### Managing Multiple Instances

```bash
# Start instance 1
cd instance1/docker
docker compose up -d

# Start instance 2
cd instance2/docker
docker compose up -d

# List all running instances
docker ps --filter "name=supabase"

# View specific instance logs
docker compose -p prod_supabase logs -f
```

## Troubleshooting

### Common Issues

**Services won't start:**
```bash
# Check logs
docker compose logs -f

# Verify ports are available
sudo netstat -tulpn | grep -E ':(3000|8000|5432)'

# Check disk space
df -h
```

**Database connection errors:**
```bash
# Verify database is running
docker compose ps db

# Check database logs
docker compose logs db

# Test connection
docker exec -it supabase-db psql -U postgres -c "SELECT version();"
```

**Authentication issues:**
```bash
# Verify JWT secret is set
grep JWT_SECRET docker/.env

# Regenerate tokens
./scripts/generate-secrets.sh --jwt-only

# Restart auth service
docker compose restart auth
```

**Port conflicts:**
```bash
# Find what's using the port
sudo lsof -i :8000

# Change port in .env
PORT_OFFSET=100

# Restart services
docker compose down && docker compose up -d
```

### Getting Help

1. Check [`docs/TROUBLESHOOTING.md`](docs/TROUBLESHOOTING.md)
2. Review service logs: `docker compose logs -f [service]`
3. Verify configuration: `./scripts/validate-instance.sh`
4. Check health: `./scripts/health-check.sh`

## Documentation

Comprehensive documentation is available in the [`docs/`](docs/) directory:

- [**Setup Guide**](docs/SETUP.md) - Initial setup and configuration
- [**Deployment Guide**](docs/DEPLOYMENT.md) - Production deployment procedures
- [**Architecture**](docs/ARCHITECTURE.md) - System architecture and components
- [**API Reference**](docs/API_REFERENCE.md) - API endpoints and usage
- [**Backup & Recovery**](docs/BACKUP_RECOVERY.md) - Backup and disaster recovery
- [**Environment Variables**](docs/ENVIRONMENT_VARIABLES.md) - Configuration reference
- [**Troubleshooting**](docs/TROUBLESHOOTING.md) - Common issues and solutions

## Security Best Practices

### Development

- ‚úÖ Use generated secrets (never use defaults)
- ‚úÖ Keep `.env` file secure (never commit to git)
- ‚úÖ Use strong passwords
- ‚úÖ Enable email confirmation for signups

### Production

- ‚úÖ Use production-grade secrets (32+ characters)
- ‚úÖ Enable HTTPS with valid SSL certificates
- ‚úÖ Configure firewall rules
- ‚úÖ Disable public signups if not needed
- ‚úÖ Use external SMTP service
- ‚úÖ Enable row-level security policies
- ‚úÖ Regular security updates
- ‚úÖ Automated backups
- ‚úÖ Monitor logs for suspicious activity
- ‚úÖ Use secrets manager (AWS Secrets Manager, HashiCorp Vault)

## Maintenance

### Regular Tasks

**Daily:**
- Monitor service health
- Check disk space
- Review error logs

**Weekly:**
- Verify backups are working
- Check for security updates
- Review access logs

**Monthly:**
- Update Docker images
- Rotate secrets (if required)
- Test disaster recovery
- Review and optimize database

### Updates

```bash
# Pull latest images
cd docker
docker compose pull

# Deploy updates
cd ..
./scripts/deploy.sh --production

# Verify deployment
./scripts/health-check.sh
```

## Performance Optimization

### Database

```sql
-- Create indexes for frequently queried columns
CREATE INDEX idx_users_email ON users(email);

-- Analyze query performance
EXPLAIN ANALYZE SELECT * FROM your_table WHERE condition;

-- Vacuum database
VACUUM ANALYZE;
```

### Docker

```bash
# Limit container resources
docker compose up -d --scale studio=1 --memory="2g" --cpus="2"

# Clean up unused resources
docker system prune -a
```

## Support

- **Documentation**: See [`docs/`](docs/) directory
- **Issues**: Report via GitHub Issues
- **Community**: Join the Supabase community
- **Commercial Support**: Contact for enterprise support options

## License

[Your License Here]

## Acknowledgments

Built on top of the excellent [Supabase](https://supabase.com) open-source project.

---

**Quick Links:**
- [Installation](#development-installation) | [Production Setup](#production-installation) | [Usage](#usage) | [Troubleshooting](#troubleshooting)
- [Scripts](scripts/) | [Documentation](docs/) | [Configuration](#configuration)

**Status**: Production Ready  
**Version**: 1.0.0  
**Last Updated**: 2025-11-25